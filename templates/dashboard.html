{% extends "base.html" %}
{% load sprite_tags %}

{% block title %}GTD Dashboard{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}



{% block content %}
<div class="px-4 py-6 sm:px-0" hx-ext="morph" id="dashboard-body">
    <!-- Welcome Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Hello {{ request.user.first_name|default:"!" }}!</h2>
                <p class="mt-1 text-sm text-gray-600">Here's your GTD overview for today</p>
                <div class="mt-2 flex items-center space-x-4">
                    <span class="text-xs text-gray-500">Last updated: <span id="last-updated">{{ now|date:"H:i" }}</span></span>
                </div>
            </div>
            <div>
                <a href="{% url 'item_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    {% sprite "lucide-circle-plus" 24 class="mr-2" %}
                    Create Item
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards Partial -->
    {% include "partials/stats_cards.html" %}

    <!-- Search Box Partial -->
    {% include "partials/search_box.html" with item_secondary_classes="cursor-pointer" %}

    <!-- Charts Section Partial -->
    {% include "partials/charts_section.html" %}

    <!-- Urgent Items Partial -->
    {% include "partials/urgent_items.html" %}

    <!-- Recent Activity Partial -->
    {% include "partials/recent_activity.html" with item_secondary_classes="cursor-pointer" %}
</div>

<script>
// Update last updated timestamp
document.addEventListener('htmx:afterSwap', function(evt) {
    const lastUpdated = document.getElementById('last-updated');
    if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleTimeString('en-US', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit'
        });
    }
});

// Global refresh function
function refreshDashboard() {
    htmx.trigger(document.body, 'refresh-dashboard');
}

// Keyboard shortcut for refresh (Ctrl+R or Cmd+R)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        refreshDashboard();
    }
});

// Connection status indicator
window.isOnline = navigator.onLine;
document.addEventListener('htmx:responseError', function(evt) {
    if (!navigator.onLine) {
        // Show offline indicator
        const offlineIndicator = document.createElement('div');
        offlineIndicator.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        offlineIndicator.textContent = 'Connection lost - Updates paused';
        offlineIndicator.id = 'offline-indicator';
        document.body.appendChild(offlineIndicator);
    }
});

window.addEventListener('online', function() {
    window.isOnline = true;
    const indicator = document.getElementById('offline-indicator');
    if (indicator) {
        indicator.remove();
    }
    // Refresh dashboard when coming back online
    refreshDashboard();
});

window.addEventListener('offline', function() {
    window.isOnline = false;
});

// Clickable data attributes for filtering
document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-project], [data-area], [data-context], [data-energy], [data-tag]');
    if (!target) return;

    e.preventDefault();
    e.stopPropagation();

    let filter = '';

    if (target.hasAttribute('data-project')) {
        filter = `parent:"${target.getAttribute('data-project')}"`;
    } else if (target.hasAttribute('data-area')) {
        filter = `area:"${target.getAttribute('data-area')}"`;
    } else if (target.hasAttribute('data-context')) {
        filter = `context:"${target.getAttribute('data-context')}"`;
    } else if (target.hasAttribute('data-energy')) {
        filter = `energy:"${target.getAttribute('data-energy')}"`;
    } else if (target.hasAttribute('data-tag')) {
        filter = `tag:"${target.getAttribute('data-tag')}"`;
    }

    if (filter) {
        // Find the search input
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            addFilter(filter);
        }
    }
});
// URL management
function updateUrl(query) {
    const url = new URL(window.location);
    if (query && query.trim()) {
        url.searchParams.set('q', query.trim());
    } else {
        url.searchParams.delete('q');
    }
    console.log("update url " + url)
    // history.replaceState(null, '', url);
}

document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', (e) => {
        const target = e.target.closest('#clear-search');
        if (!target) return;

        e.preventDefault()
        const searchInput = document.getElementById('search-input');
        searchInput.value = '';
        htmx.trigger(searchInput, 'input');

        updateFilterStates();
        updateUrl('');
    });
})

function isFilterActive(filter) {
    const searchInput = document.getElementById('search-input');
    const currentValue = searchInput.value.trim();

    // Escape special regex characters
    const escapedFilter = filter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // For quoted filters (area/context), use more flexible matching
    if (filter.includes('"')) {
        // Match the filter surrounded by word boundaries or spaces
        const regex = new RegExp('(^|\\s)' + escapedFilter + '(\\s|$)');
        return regex.test(currentValue);
    } else {
        // Use word boundary for simple filters
        const regex = new RegExp('\\b' + escapedFilter + '\\b');
        return regex.test(currentValue);
    }
}

function addFilter(filter) {
    const searchInput = document.getElementById('search-input');
    const currentValue = searchInput.value.trim();

    // Check if filter already exists - if so, remove it
    if (isFilterActive(filter)) {
        removeFilter(filter);
        return;
    }

    // Add the filter with a space if there's existing content
    const newValue = currentValue ? `${currentValue} ${filter}` : filter;
    searchInput.value = newValue;

    // Trigger the search
    htmx.trigger(searchInput, 'input');

    // Update filter button states and URL
    updateFilterStates();
    updateUrl(newValue);

    // Focus back on the input
    searchInput.focus();
}

function removeFilter(filter) {
    const searchInput = document.getElementById('search-input');
    const currentValue = searchInput.value.trim();

    // Escape special regex characters
    const escapedFilter = filter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // Remove the filter using appropriate regex based on whether it's quoted
    let regex;
    if (filter.includes('"')) {
        // For quoted filters, match with flexible spacing
        regex = new RegExp('\\s*(^|\\s)' + escapedFilter + '(\\s|$)\\s*', 'g');
    } else {
        // Use word boundary for simple filters
        regex = new RegExp('\\s*\\b' + escapedFilter + '\\b\\s*', 'g');
    }

    const newValue = currentValue.replace(regex, ' ').replace(/\s+/g, ' ').trim();

    searchInput.value = newValue;

    // Trigger the search
    htmx.trigger(searchInput, 'input');

    // Update filter button states and URL
    updateFilterStates();
    updateUrl(newValue);

    // Focus back on the input
    searchInput.focus();
}

function updateFilterStates() {
    document.querySelectorAll('.filter-suggestion').forEach(function(button) {
        const filter = button.getAttribute('data-filter');
        const isActive = isFilterActive(filter);
        const colorCategory = button.getAttribute('data-color') || 'gray';

        // Toggle between inactive and active states
        // Inactive state classes
        button.classList.toggle(`bg-${colorCategory}-100`, !isActive);
        button.classList.toggle(`text-${colorCategory}-700`, !isActive);
        button.classList.toggle(`hover:bg-${colorCategory}-200`, !isActive);

        // Active state classes
        button.classList.toggle(`bg-${colorCategory}-600`, isActive);
        button.classList.toggle('text-white', isActive);
        button.classList.toggle(`hover:bg-${colorCategory}-700`, isActive);
        button.classList.toggle('ring-2', isActive);
        button.classList.toggle(`ring-${colorCategory}-300`, isActive);
    });
}

function initializeFilterSuggestions() {
    document.addEventListener('click', function(e) {
        const target = e.target.closest('.filter-suggestion');
        if (!target) return;
        const filter = target.getAttribute('data-filter');
        if (!filter) return;
        addFilter(filter);
    })
}

// Add event listeners for filter suggestions
document.addEventListener('DOMContentLoaded', function() {
    initializeFilterSuggestions();

    // Initial state update
    updateFilterStates();

    // Trigger initial search if there's a query in the input
    const searchInput = document.getElementById('search-input');
    if (searchInput && searchInput.value.trim()) {
        htmx.trigger(searchInput, 'input');
    }
});

// Update filter states and URL when user types
document.getElementById('search-input').addEventListener('input', function() {
    updateFilterStates();
    updateUrl(this.value);
});

// Re-initialize filter suggestions when HTMX loads new content
document.addEventListener('htmx:afterSwap', function() {
    updateFilterStates()
});


// Initialize stats filter buttons
function initializeStatsFilters() {
    document.querySelectorAll('.stats-filter-btn').forEach(function(button) {
        // Remove existing listeners to avoid duplicates
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        // Add new listener
        newButton.addEventListener('click', function() {
           const filter = this.getAttribute('data-filter');
           setSearchFilter(filter);
        });
    });
}

function setSearchFilter(filter) {
    const searchInput = document.getElementById('search-input');
    if (!searchInput) return;

    console.log("Set search filter",filter)


    // Replace the entire search query with this filter
    searchInput.value = filter;

    // Trigger the search
    htmx.trigger(searchInput, 'input');

    // Update filter button states if the function exists
    updateFilterStates();

    // Focus on the search input
    searchInput.focus();

    // Scroll to search results if they exist
    const searchContainer = document.getElementById('search-results-container');
    if (searchContainer) {
        searchContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeStatsFilters();
});

// Re-initialize when HTMX loads new content
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.matches('[hx-get*="dashboard_stats"]')) {
        initializeStatsFilters();
    }
});
</script>
{% endblock %}